name: Cloud Resume Backend Package

run-name: Deploy to AWS by @${{ github.actor }}

on: push

jobs:
    run-tests:

        runs-on: ubuntu-latest
        strategy:
            matrix:
                # python-version: ["3.7", "3.8", "3.9", "3.10", "3.11"]
                python-version: ["3.11"]

        
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v4
              with:
                python-version: ${{ matrix.python-version }}

            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install pytest
                pip install moto
                pip install boto3

            - name: Run tests
              run: pytest
    terraform:
        needs: ['run-tests']

        runs-on: ubuntu-latest

        defaults:
          run:
            working-directory: ./

        permissions:
          id-token: write # This is required for requesting the JWT
          contents: read  # This is required for actions/checkout
       
        steps:
            - name: Git clone the repository
              uses: actions/checkout@v3

            - name: configure aws credentials
              uses: aws-actions/configure-aws-credentials@v3
              with:
                role-to-assume: ${{ secrets.ROLE_TO_ASSUME }}
                role-duration-seconds: 900
                aws-region: us-east-1

            - name: Use Terraform 1.5.7
              uses: hashicorp/setup-terraform@v2
              with:
                terraform_version: 1.5.7
            
            # - name: Initialize Terraform
            #   run: terraform init

            - name: Terraform Plan & Apply api_resources
              run: |
                cd infrastructure/api_resources
                terraform init
                terraform plan
                # terraform apply -auto-approve

            - name: Terraform Plan & Apply iam_resources
              run: |
                cd infrastructure/iam_resources
                terraform init
                terraform plan
                # terraform apply -auto-approve
              


            
        
